<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>
    Loading ESA Digital Map
  </title>
  <link rel="icon" href="Images/EPADPLogo.png">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.23/"></script>

  <style>
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      flex: 1;
    }
    body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      .esri-popup--is-docked-top-right .esri-popup__main-container {
        max-height: 100%;
      }

      #appContainer {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
      }

      .container {
        display: flex;
        flex: 1;
        width: 100%;
      }

      .switch {
        position: relative;
        display: inline-block;
        width: 45px;
        height: 22px;
        vertical-align: middle;
      }

      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 1px;
        background-color: white;
        -webkit-transition: 0.4s;
        transition: 0.4s;
      }

      input:checked + .slider {
        background-color: #2196f3;
      }

      input:focus + .slider {
        box-shadow: 0 0 1px #2196f3;
      }

      input:checked + .slider:before {
        -webkit-transform: translateX(20px);
        -ms-transform: translateX(20px);
        transform: translateX(20px);
      }

      /* Rounded sliders */

      .slider.round {
        border-radius: 20px;
      }

      .slider.round:before {
        border-radius: 50%;
      }

      .labelText {
        padding-left: 5px;
        font-size: 15px;
      }

      #mainDiv {
        padding: 8px;
      }
  </style>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend",
      "esri/layers/GeoJSONLayer",
      "esri/widgets/Home",
      "esri/smartMapping/renderers/color",
      "esri/smartMapping/symbology/color",
      "esri/smartMapping/symbology/support/colorRamps",
      "esri/layers/GraphicsLayer",
      "esri/smartMapping/statistics/summaryStatistics",
      "esri/widgets/Expand",
      "esri/widgets/Editor",
      "esri/renderers/UniqueValueRenderer",
      "esri/widgets/Bookmarks",
      "esri/geometry/geometryEngine",
      "esri/layers/support/FeatureFilter",
      "esri/smartMapping/renderers/type",
      "esri/widgets/FeatureTable",
      "esri/core/reactiveUtils",
      "esri/Graphic",
    ], (
      Map,
      MapView,
      FeatureLayer,
      Legend,
      GeoJSONLayer,
      Home,
      colorRendererCreator,
      colorSymbology,
      colorRamps,
      Graphic,
      SummaryStatistics,
      Expand,
      Editor,
      UniqueValueRenderer,
      Bookmarks,
      geometryEngine,
      FeatureFilter,
      typeRendererCreator,
      FeatureTable,
      reactiveUtils,
      Graphic,

    ) => {

      const projectsLyr = new FeatureLayer({
        url: "https://services8.arcgis.com/QF1SFulWoGe9X2JG/arcgis/rest/services/EPADPDemo/FeatureServer/0",
        title: "Projects"
      });
      const gridLines = new FeatureLayer({
        url: "https://services8.arcgis.com/QF1SFulWoGe9X2JG/arcgis/rest/services/قاعدة_بيانات_منطقة_gdb/FeatureServer/6",
        title: "Grid lines"
      });


      const gridPoints = new FeatureLayer({
        url: "https://services8.arcgis.com/QF1SFulWoGe9X2JG/arcgis/rest/services/قاعدة_بيانات_منطقة_gdb/FeatureServer/18",
        title: "Field points",
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",
            size: 6,
            color: "blue",
            outline: {
              width: 0.5,
              color: "black"
            }
          }
        }
      });

      const map = new Map({
        basemap: "satellite",
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        center: [30, 20],
        zoom: 5,

      });

      map.addMany([gridLines, gridPoints, projectsLyr])

      const directionParams = {
        layer: gridLines,
        view: view,
        field: "Direction",
        legendOptions: {
          title: "Direction"
        }
      };

      typeRendererCreator
        .createRenderer(directionParams)
        .then((response) => {
          response.renderer.defaultSymbol = null
          gridLines.renderer = response.renderer;
          if (!map.layers.includes(gridLines)) {
            map.add(gridLines);
          }
        })
        .catch((error) => {
          console.error("there was an error: ", error);
        });

        const typeParams = {
        layer: projectsLyr,
        view: view,
        field: "Type",
        legendOptions: {
          title: "Type"
        }
      };

      typeRendererCreator
        .createRenderer(typeParams)
        .then((response) => {
          response.renderer.uniqueValueInfos.map(each => {
            each.symbol.color['a'] = 0.5;
            each.symbol.outline = {
              width: 0.5,
              color: 'black'
            }
          })

          response.renderer.defaultSymbol = null
          projectsLyr.renderer = response.renderer;
          if (!map.layers.includes(projectsLyr)) {
            map.add(projectsLyr);
          }
        })
        .catch((error) => {
          console.error("there was an error: ", error);
        });



      const getLayerView = (layer) => {
        return view
          .whenLayerView(layer)
      }

      const excludeOutsideFeatures = (layer, geometry) => {
        getLayerView(layer)
          .then((returnedLayerView) => {
            let layerView = returnedLayerView;
            layerView.filter = new FeatureFilter({
              spatialRelationship: "intersects",
              geometry: geometry,
            });
          })
      }

      projectsLyr.queryFeatures().then(function (results) {
        geometry = results.features[results.features.length - 1].geometry;
      }).then(() => {

        projectsLyr.queryFeatures().then(function (results) {
          view.goTo(geometry, { duration: 2500 });
        });

        excludeOutsideFeatures(gridLines, geometry)
        excludeOutsideFeatures(gridPoints, geometry)
      })

      let legend = new Legend({
        view: view,
      })
      let homeWidget = new Home({ view: view });
      let bookmarks = new Bookmarks({
        view: view,
        editingEnabled: true,
        visibleElements: {
          time: false
        }
      });

      const bkExpand = new Expand({
        view: view,
        content: bookmarks,
        expandTooltip: "Expand bookmarks tooltip",
        expanded: false
      });


      const legendExpand = new Expand({
        view: view,
        content: legend,
        expandTooltip: "Expand legend",
        expanded: false
      });

      view.ui.add(bkExpand, "top-left");
      view.ui.add(homeWidget, "top-left");
      view.ui.add(legendExpand, "top-left");

      
    view.when(()=>{

        let features = []
        let fields = [{
                name: "ObjectID",
                alias: "ObjectID",
                type: "oid",
            },
            {
                name: "AttackRate",
                alias: "AttackRate",
                type: "double",
            },
            {
                name: "CFR",
                alias: "CFR",
                type: "double",
            },
            {
                name: "RecoveryRate",
                alias: "RecoveryRate",
                type: "double",
            },
            {
                name: "SampleTested",
                alias: "SampleTested",
                type: "double",
            },
            {
                name: "Population",
                alias: "Population",
                type: "integer",
            },
            {
                name: "Name",
                alias: "Name",
                type: "string",
            },
            {
                name: "MortalityRate",
                alias: "MortalityRate",
                type: "double",
            }]

            features.push(
                            new Graphic({
                                geometry: feature.geometry,
                                attributes: {
                                    Name: feature.attributes.Name,
                                    Population: feature.attributes.Population,
                                    AttackRate: record.attributes.AttackRate,
                                    CFR: record.attributes.CFR,
                                    RecoveryRate: record.attributes.RecoveryRate,
                                    SampleTested: record.attributes.SampleTested,
                                    MortalityRate: record.attributes.MortalityRate,
                                },
                            })
                        );  
                        var foreGroundNewlyr = new FeatureLayer({
                        source: featuresToBeAdded,
                        objectIdField: "ObjectID_1",
                        fields:  fields,
                        
                      });               
        const featureLayer = gridPoints;
        //   featureLayer.title = "US Private school enrollment";
          featureLayer.outFields = ["*"];

          // Get references to div elements for toggling table visibility
          const appContainer = document.getElementById("appContainer");
          const tableContainer = document.getElementById("tableContainer");
          const tableDiv = document.getElementById("tableDiv");

          // Create FeatureTable
          const featureTable = new FeatureTable({
            view: view, // make sure to pass in view in order for selection to work
            layer: featureLayer,
            tableTemplate: {
              // autocasts to TableTemplate
            //   columnTemplates: [
            //     // takes an array of GroupColumnTemplate and FieldColumnTemplate
            //     {
            //       // autocasts to FieldColumnTemplate
            //       type: "field",
            //       fieldName: "state_name",
            //       label: "State",
            //       direction: "asc"
            //     },
            //     {
            //       type: "field",
            //       fieldName: "PercentagePrivate",
            //       label: "Private school percentage"
            //     },
            //     {
            //       type: "field",
            //       fieldName: "PercentagePublic",
            //       label: "Public school percentage"
            //     }
            //   ]
            },
            container: tableDiv
          });

          view.ui.add(document.getElementById("mainDiv"), "top-right");

          const checkboxEle = document.getElementById("checkboxId");
          const labelText = document.getElementById("labelText");

          checkboxEle.onchange = () => {
            toggleFeatureTable();
          };

          function toggleFeatureTable() {
            if (!checkboxEle.checked) {
              appContainer.removeChild(tableContainer);
              labelText.innerHTML = "Show elevation points table";
            } else {
              appContainer.appendChild(tableContainer);
              labelText.innerHTML = "Hide elevation points table";
            }
          }

          featureTable.on("selection-change", (changes) => {
            // If row is unselected in table, remove it from the features array
            changes.removed.forEach((item) => {
              const data = features.find((data) => {
                return data.feature === item.feature;
              });
            });

            // If a row is selected, add to the features array
            changes.added.forEach((item) => {
              const feature = item.feature;
              features.push({
                feature: feature
              });

              // Listen for row selection in the feature table. If the popup is open and a row is selected that is not the same feature as opened popup, close the existing popup.
              if (
                feature.attributes.OBJECTID !== id &&
                view.popup.visible === true
              ) {
                featureTable.deselectRows(selectedFeature);
                view.popup.close();
              }
            });
          });

          // Watch for the popup's visible property. Once it is true, clear the current table selection and select the corresponding table row from the popup
          reactiveUtils.watch(
            () => view.popup.viewModel.active,
            () => {
              selectedFeature = view.popup.selectedFeature;
              if (selectedFeature !== null && view.popup.visible !== false) {
                featureTable.clearSelection();
                featureTable.selectRows(view.popup.selectedFeature);
                id = selectedFeature.getObjectId();
              }
            }
          );
    })


    });
  </script>

</head>

<body>
    <div id="appContainer">
        <div id="viewDiv"></div>
        <div id="tableContainer" class="container">
          <div id="tableDiv"></div>
        </div>
        <div id="mainDiv" class="esri-widget">
          <label class="switch">
            <input id="checkboxId" type="checkbox" checked="yes" />
            <span class="slider round"></span>
          </label>
          <label class="labelText" id="labelText">Hide elevation points table</label>
        </div>
      </div>
    </body>
</html>