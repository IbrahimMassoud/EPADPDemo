<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>
    EPADP Demo
  </title>
  <link rel="icon" href="Images/EPADPLogo.png">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://js.arcgis.com/4.23/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.23/"></script>
  <!-- <script src="main.js" type="text/javascript"></script> -->
  <link rel="stylesheet" href="style.css">

  <style>
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend",
      "esri/layers/GeoJSONLayer",
      "esri/widgets/Home",
      "esri/smartMapping/renderers/color",
      "esri/smartMapping/symbology/color",
      "esri/smartMapping/symbology/support/colorRamps",
      "esri/layers/GraphicsLayer",
      "esri/smartMapping/statistics/summaryStatistics",
      "esri/widgets/Expand",
      "esri/widgets/Editor",
      "esri/renderers/UniqueValueRenderer",
      "esri/widgets/Bookmarks",
      "esri/geometry/geometryEngine",
      "esri/layers/support/FeatureFilter"
    ], (
      Map,
      MapView,
      FeatureLayer,
      Legend,
      GeoJSONLayer,
      Home,
      colorRendererCreator,
      colorSymbology,
      colorRamps,
      Graphic,
      SummaryStatistics,
      Expand,
      Editor,
      UniqueValueRenderer,
      Bookmarks,
      geometryEngine,
      FeatureFilter

    ) => {

      // let gridsLayerView, pointsLayerView;
      const colors = ["#d92b30", "#3cccb4", 'black'];

      const commonProperties = {
        type: "simple-line",
        width: "2px",
        style: "solid"
      };

      const horizontal = {
        ...commonProperties,
        color: colors[0]
      };

      const vertical = {
        ...commonProperties,
        color: colors[1]
      };
      const otherSym = {
        ...commonProperties,
        color: colors[2]
      };


      const projectsLyr = new FeatureLayer({
        url: "https://services8.arcgis.com/QF1SFulWoGe9X2JG/arcgis/rest/services/EPADPDemo/FeatureServer/0",
        title: "Projects"
      });
      const gridLines = new FeatureLayer({
        url: "https://services8.arcgis.com/QF1SFulWoGe9X2JG/arcgis/rest/services/قاعدة_بيانات_منطقة_gdb/FeatureServer/6",
        title: "Grid lines"
      });


      const gridsRenderer = {
        type: "unique-value", // autocasts as new UniqueValueRenderer()
        legendOptions: {
          title: " "
        },
        defaultSymbol: otherSym,
        defaultLabel: "Other",
        field: "Direction",

        uniqueValueInfos: [
          {
            value: 0,
            symbol: horizontal,
            label: "Horizontal"
          },
          {
            value: 1,
            symbol: vertical,
            label: "Vertical"
          }
        ]
      };
      // gridsRenderer.addUniqueValueInfo("Horizontal", horizontal);
      // gridsRenderer.addUniqueValueInfo("Vertical", vertical);


      gridLines.renderer = gridsRenderer

      const gridPoints = new FeatureLayer({
        url: "https://services8.arcgis.com/QF1SFulWoGe9X2JG/arcgis/rest/services/قاعدة_بيانات_منطقة_gdb/FeatureServer/18",
        title: "Field points",
        renderer: {
          type: "simple",
          symbol: {
            type: "simple-marker",
            size: 6,
            color: "yellow",
            outline: {
              width: 0.5,
              color: "white"
            }
          }
        }
      });

      const lyrInfos = {
        layer: projectsLyr,
        groupDisplay: "sequential",
        formTemplate: {
          title: "Project information",
          elements: [
            {
              type: "group",
              label: "Basic information",
              elements: [
                {
                  type: "field",
                  fieldName: "ArabicName",
                  label: "Arabic Name"
                },
                {
                  type: "field",
                  fieldName: "EnglishName",
                  label: "English Name"
                },
                {
                  type: "field",
                  fieldName: "Type",
                  label: "Type"
                },
                {
                  type: "field",
                  fieldName: "Area",
                  label: "Area"
                }
              ]
            },
            {
              type: "group",
              label: "Location data",
              elements: [
                {
                  type: "field",
                  fieldName: "Sector",
                  label: "Sector"
                },
                {
                  type: "field",
                  fieldName: "Directorate",
                  label: "Directorate"
                },
                {
                  type: "field",
                  fieldName: "Section",
                  label: "Section"
                },
                {
                  type: "field",
                  fieldName: "Governorate",
                  label: "Governorate"
                }

              ]
            },
            {
              type: "group",
              label: "Drains",
              elements: [
                {
                  type: "field",
                  fieldName: "DrainEnglishName",
                  label: "Drain English Name"
                },
                {
                  type: "field",
                  fieldName: "DrainArabicName",
                  label: "Drain Arabic Name"
                }
              ]
            }
          ]
        }
      };

      const map = new Map({
        basemap: "satellite",
      });

      const view = new MapView({
        container: "viewDiv",
        map: map,
        // center: [30.855,29],
        // zoom:18,
        constraints: {

          minScale: 70000,
          maxScale: 2000,
          rotationEnabled: false
        },
        center: [30.825, 31.16],
        zoom: 16,
      });

      map.addMany([gridLines, gridPoints, projectsLyr])

      const getLayerView = (layer) => {
        return view
          .whenLayerView(layer)
      }

      const excludeOutsideFeatures = (layer, geometry) => {
        getLayerView(layer)
          .then((returnedLayerView) => {
            let layerView = returnedLayerView;
            layerView.filter = new FeatureFilter({
              spatialRelationship: "intersects",
              geometry: geometry,
            });
          })
      }

      projectsLyr.queryFeatures().then(function (results) {
        geometry = results.features[results.features.length - 1].geometry;
        console.log(results.features);
      }).then(() => {
        excludeOutsideFeatures(gridLines, geometry)
        excludeOutsideFeatures(gridPoints, geometry)
      })

      let legend = new Legend({ view })
      let homeWidget = new Home({ view: view });
      let bookmarks = new Bookmarks({
        view: view,
        editingEnabled: true,
        visibleElements: {
          time: false
        }
      });

      const bkExpand = new Expand({
        view: view,
        content: bookmarks,
        expandTooltip: "Expand bookmarks tooltip",
        expanded: false
      });


      const legendExpand = new Expand({
        view: view,
        content: legend,
        expandTooltip: "Expand legend tooltip",
        expanded: false
      });


      const editor = new Editor({
        view: view,
        layerInfos: [lyrInfos],
        allowedWorkflows: ["update", "create"],
      });

      editorExpand = new Expand({
        expandIconClass: "esri-icon-edit \ue61b",
        expandTooltip: "Expand editor tooltip",
        view: view,
        content: editor
      });

      view.ui.add(bkExpand, "top-right");
      view.ui.add(editorExpand, "top-right");
      view.ui.add(homeWidget, "top-left");
      view.ui.add(legendExpand, "top-left");

      view.when(() => {
        editor.messages['createFeatures'] = " ";
        editor.messages['editFeatures'] = "Edit projects";
        editor.messages['editFeature'] = "Edit project";
        editor.messages['selectFeature'] = "select project";
        editor.messages['selectFeatureToEdit'] = "Select a project to start editing"
      })
    });

  </script>

</head>

<body>
  <div id="viewDiv">
    <div id="formDiv"></div>
  </div>
</body>

</html>